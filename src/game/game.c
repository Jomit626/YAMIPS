#include "display.h"
#include "../driver/segment_display.h"
#include "../driver/timer.h"
#include "../interrupt/interrupt_enter.h"

#define BUTTON_UP       (0x1 << 1)
#define BUTTON_LEFT     (0x1 << 2)
#define BUTTON_RIGHT    (0x1 << 3)
#define BUTTON_DOWN     (0x1 << 4)
#define BUTTON_CENTER    (0x1 << 5)

static unsigned buttons = 0x0;
static unsigned frame_time = 0x0;
static int x = 0;
static int y = 0;

#define BACK_GROUND_COLOR 0x0fff0fff
#define PLAYER_COLOR 0x0f000f00

const unsigned player_image[DISPLAY_IMAGE_SIZE_WORD] = {
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0f000f00,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff,
    0x0fff0fff,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0f000f00,0x0fff0fff,0x0fff0fff,0x0fff0fff
};

void int_handler(unsigned cause){
    buttons |= (0x1 << cause);
}

unsigned game_loop(){
    register int new_x = x, new_y = y;
    register int old_x = new_x, old_y = new_y;
    register int changed = 0;
    register unsigned button_status = buttons;
    register unsigned exit = 0;

    if(button_status & BUTTON_UP){
        new_x -= 1;
        changed = 1;
    }
    if(button_status & BUTTON_LEFT){
        new_y -= 1;
        changed = 1;
    }
    if(button_status & BUTTON_RIGHT){
        new_y += 1;
        changed = 1;
    }
    if(button_status & BUTTON_DOWN){
        new_x += 1;
        changed = 1;
    }
    if(button_status & BUTTON_CENTER){
        exit = 1;
    }

    if( new_x < 0)
        new_x = 0;
    else if (new_x >= DISPLAY_HEIGHT)
        new_x = DISPLAY_HEIGHT - 1;

    if( new_y < 0)
        new_y = 0;
    else if (new_y >= DISPLAY_WIDTH)
        new_y = DISPLAY_WIDTH - 1;

    if(changed){
        // clean old pos
        display_set_color(old_x, old_y, BACK_GROUND_COLOR);
        // draw new pos
        display_set_image(new_x, new_y, player_image);
        x = new_x;
        y = new_y;
    }

    return exit;
}

void game_init(){
    buttons = 0;
    x = y = 0;
    display_set_image(0, 0, player_image);
}

void main(){
    // interrupt init
    load_int_enter();

    // graphic init
    vdma_init();
    vdma_ram_init();

    game_init();


    // main game loop
    register unsigned frame_interval = 33333; // 33.333 ms between frames
    register unsigned last_frame_time;
    while(1){
        last_frame_time = frame_time;

        // wait next frame
        while((TIME - last_frame_time) < frame_interval)
            ;
        frame_time = TIME;

        if( game_loop() )
            break;

        // clean buttons, because interrupt comes only when buttons are pressed
        buttons = 0;
    }
}